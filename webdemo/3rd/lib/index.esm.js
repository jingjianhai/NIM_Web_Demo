import e from"../assets/sdk/NIM_Web_WebRTC2_v3.7.0.js";import t from"../assets/sdk/NIM_Web_SDK_v8.1.0.js";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};var s=function(){return(s=Object.assign||function(e){for(var t,n=1,s=arguments.length;n<s;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function i(e,t,n,s){return new(n||(n=Promise))((function(i,r){function a(e){try{l(s.next(e))}catch(e){r(e)}}function o(e){try{l(s.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}l((s=s.apply(e,t||[])).next())}))}function r(e,t){var n,s,i,r,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function o(r){return function(o){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,s&&(i=2&r[0]?s.return:r[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,r[1])).done)return i;switch(s=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,s=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==r[0]&&2!==r[0])){a=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){a.label=r[1];break}if(6===r[0]&&a.label<i[1]){a.label=i[1],i=r;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(r);break}i[2]&&a.ops.pop(),a.trys.pop();continue}r=t.call(e,a)}catch(e){r=[6,e],s=0}finally{n=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,o])}}}function a(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var s,i,r=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(s=r.next()).done;)a.push(s.value)}catch(e){i={error:e}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}return a}function o(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(a(arguments[t]));return e}var l,c,u=(function(e){var t=Object.prototype.hasOwnProperty,n="~";function s(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function r(e,t,s,r,a){if("function"!=typeof s)throw new TypeError("The listener must be a function");var o=new i(s,r||e,a),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function o(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,s,i=[];if(0===this._eventsCount)return i;for(s in e=this._events)t.call(e,s)&&i.push(n?s.slice(1):s);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(e){var t=n?n+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var i=0,r=s.length,a=new Array(r);i<r;i++)a[i]=s[i].fn;return a},o.prototype.listenerCount=function(e){var t=n?n+e:e,s=this._events[t];return s?s.fn?1:s.length:0},o.prototype.emit=function(e,t,s,i,r,a){var o=n?n+e:e;if(!this._events[o])return!1;var l,c,u=this._events[o],h=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),h){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,s),!0;case 4:return u.fn.call(u.context,t,s,i),!0;case 5:return u.fn.call(u.context,t,s,i,r),!0;case 6:return u.fn.call(u.context,t,s,i,r,a),!0}for(c=1,l=new Array(h-1);c<h;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var d,f=u.length;for(c=0;c<f;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),h){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,s);break;case 4:u[c].fn.call(u[c].context,t,s,i);break;default:if(!l)for(d=1,l=new Array(h-1);d<h;d++)l[d-1]=arguments[d];u[c].fn.apply(u[c].context,l)}}return!0},o.prototype.on=function(e,t,n){return r(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return r(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,s,i){var r=n?n+e:e;if(!this._events[r])return this;if(!t)return a(this,r),this;var o=this._events[r];if(o.fn)o.fn!==t||i&&!o.once||s&&o.context!==s||a(this,r);else{for(var l=0,c=[],u=o.length;l<u;l++)(o[l].fn!==t||i&&!o[l].once||s&&o[l].context!==s)&&c.push(o[l]);c.length?this._events[r]=1===c.length?c[0]:c:a(this,r)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new s,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o}(l={exports:{}},l.exports),l.exports),h={code:"100",message:"未知错误"},d={code:"101",message:"disconnect failed"},f={code:"102",message:"signal is null"},p={code:"103",message:"channelInfo is null"},v={code:"104",message:"client is null"},g={code:"105",message:"stream is null"},m={code:"106",message:"callType is null"},y={code:"107",message:"invite all failed"},I={code:"109",message:"groupInvite part failed"},b={code:"110",message:"cancel part failed"},w={code:"111",message:"signal leave failed"},C={code:"112",message:"G2 RTC leave failed"},S={code:"113",message:"durations is empty"},T={code:"114",message:"deviceId is null"};!function(e){e[e.idle=0]="idle",e[e.calling=1]="calling",e[e.called=2]="called",e[e.inCall=3]="inCall"}(c||(c={}));var j=function(){return Math.ceil(1e5*Math.random())+""},P=function(a){function l(e){var t=(void 0===e?{debug:!0}:e).debug,n=void 0===t||t,s=a.call(this)||this;return s.log=null,s.localStream=null,s.remoteStreams=[],s.localView=void 0,s.remoteViews=[],s.client=null,s.signal=null,s.isConnect=!1,s.channelInfo=null,s.callingUserIds=[],s.requestId="",s.callType=null,s.appKey="",s.uid=j(),s.invitorChannelInfo=null,s.isGroupCall=!1,s.callStatus=c.idle,s.durations=[],s.userMap={},s.microphoneId="",s.cameraId="",s.speakerId="",s.audioEnabled=!1,s.videoEnabled=!1,s.callTimeout=void 0,s.rejectTimeout=void 0,s.getTokenFunc=null,s.log=function(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];e&&console.log.apply(console,o(["[NRTCCalling Message]: "],t))}}(n),s}return function(e,t){function s(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}(l,a),l.prototype.setupAppKey=function(t){var n=t.appKey;this.client||(this.appKey=n,this.client=e.createClient({appkey:this.appKey,debug:!0}),this.log("setupAppKey success"))},l.prototype.login=function(e){var n=this;return new Promise((function(s,i){n.signal=t.NIM.getInstance({appKey:n.appKey,account:e.account,token:e.token,debug:!0,onconnect:function(){var t;n.log("login success"),n.isConnect=!0,n.userMap[n.uid]=e.account,n.addEventListener(),n.signal.signalingSync(),null===(t=e.success)||void 0===t||t.call(e),s()},onerror:function(t){var s;n.log("login fail:",t),null===(s=e.failed)||void 0===s||s.call(e,t),i(t)}})}))},l.prototype.logout=function(e){var t,n;return i(this,void 0,void 0,(function(){var s;return r(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,,3]),!this.isConnect)throw d;if(!this.signal)throw f;return[4,this.signal.disconnect()];case 1:return i.sent(),delete this.userMap[this.uid],this.log("logout success"),null===(t=null==e?void 0:e.success)||void 0===t||t.call(e),[3,3];case 2:return s=i.sent(),this.log("logout fail:",s),null===(n=null==e?void 0:e.failed)||void 0===n||n.call(e,d),[2,Promise.reject(d)];case 3:return[2]}}))}))},l.prototype.call=function(e){var t,n;return i(this,void 0,void 0,(function(){var s,a,o=this;return r(this,(function(l){switch(l.label){case 0:if(l.trys.push([0,5,,6]),!this.signal)throw f;if(!this.client)throw v;return this.channelInfo?[3,3]:[4,this.signalCreate({type:e.type})];case 1:return s=l.sent(),[4,this.signal.signalingJoin({channelId:s.channelId,offlineEnabled:!0,uid:this.uid})];case 2:l.sent(),this.log("signalingJoin success！"),l.label=3;case 3:return this.callStatus=c.calling,this.isGroupCall=!1,this.durations=[{accid:this.userMap[this.uid],duration:Date.now()}],this.callingUserIds=[e.userId],this.requestId=j(),[4,this.signalInvite(e.userId)];case 4:return l.sent(),this.log("call success"),null===(t=e.success)||void 0===t||t.call(e),void 0!==this.callTimeout&&setTimeout((function(){return i(o,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:if(this.callStatus!==c.calling)return[3,7];t.label=1;case 1:return t.trys.push([1,3,4,7]),[4,this.signalCancel()];case 2:return t.sent(),this.log("signalInvite timeout cancel success",this.callTimeout),[3,7];case 3:return e=t.sent(),this.log("signalInvite timeout cancel fail: ",e,this.callTimeout),[3,7];case 4:return this.emit("onCallingTimeOut"),[4,this.sendMessage("timeout")];case 5:return t.sent(),[4,this.destroy()];case 6:return t.sent(),[7];case 7:return[2]}}))}))}),this.callTimeout),[3,6];case 5:return a=l.sent(),this.log("call fail:",a),null===(n=e.failed)||void 0===n||n.call(e,a),[2,Promise.reject(a)];case 6:return[2]}}))}))},l.prototype.groupCall=function(e){var t,n;return i(this,void 0,void 0,(function(){var s,a=this;return r(this,(function(l){switch(l.label){case 0:if(l.trys.push([0,5,,6]),!this.signal)throw f;if(!this.client)throw v;return this.channelInfo?[3,3]:[4,this.signalCreate({type:e.type})];case 1:return l.sent(),[4,this.joinSignalAndRTC()];case 2:l.sent(),l.label=3;case 3:return this.callStatus=c.calling,this.isGroupCall=!0,this.callingUserIds=o(e.userIds),this.requestId=j(),[4,this.signalGroupInvite({userIds:e.userIds,groupId:e.groupId})];case 4:return l.sent(),this.log("groupCall success"),null===(t=e.success)||void 0===t||t.call(e),void 0!==this.callTimeout&&setTimeout((function(){return i(a,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:if(this.callStatus!==c.calling)return[3,6];t.label=1;case 1:return t.trys.push([1,3,4,6]),[4,Promise.all([this.signalCancel(),this.rTCLeave()])];case 2:return t.sent(),this.log("signalGroupInvite timeout cancel success",this.callStatus),[3,6];case 3:return e=t.sent(),this.log("signalGroupInvite timeout cancel fail: ",e,this.callStatus),[3,6];case 4:return this.emit("onCallingTimeOut"),[4,this.destroy()];case 5:return t.sent(),[7];case 6:return[2]}}))}))}),this.callTimeout),[3,6];case 5:return s=l.sent(),this.log("groupCall fail",s),null===(n=e.failed)||void 0===n||n.call(e,s),[2,Promise.reject(s)];case 6:return[2]}}))}))},l.prototype.addDelegate=function(e,t){this.on(e,t)},l.prototype.removeDelegate=function(e){this.off(e)},l.prototype.cancel=function(e){var t,n;return i(this,void 0,void 0,(function(){var s;return r(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,5,,6]),!this.signal)throw f;if(!this.channelInfo)throw p;return[4,this.signalCancel()];case 1:return i.sent(),this.isGroupCall?[3,4]:[4,this.sendMessage("canceled")];case 2:return i.sent(),[4,this.destroy()];case 3:i.sent(),i.label=4;case 4:return this.log("cancel success"),null===(t=null==e?void 0:e.success)||void 0===t||t.call(e),[3,6];case 5:return s=i.sent(),this.log("cancel fail",s),null===(n=null==e?void 0:e.failed)||void 0===n||n.call(e,s),[2,Promise.reject(s)];case 6:return[2]}}))}))},l.prototype.accept=function(e){var t,n;return i(this,void 0,void 0,(function(){var s;return r(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,,3]),!this.signal)throw f;if(!this.invitorChannelInfo)throw p;if(!this.client)throw v;return[4,this.acceptSignal()];case 1:return i.sent(),this.callStatus=c.inCall,this.log("accept success"),null===(t=null==e?void 0:e.success)||void 0===t||t.call(e),[3,3];case 2:return s=i.sent(),this.log("accept fail:",s),null===(n=null==e?void 0:e.failed)||void 0===n||n.call(e,s),[2,Promise.reject(s)];case 3:return[2]}}))}))},l.prototype.reject=function(e){var t,n;return i(this,void 0,void 0,(function(){var s;return r(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,this.rejectCall(!1)];case 1:return i.sent(),this.log("reject success"),null===(t=null==e?void 0:e.success)||void 0===t||t.call(e),[3,3];case 2:return s=i.sent(),this.log("reject fail:",s),null===(n=null==e?void 0:e.failed)||void 0===n||n.call(e,s),[2,Promise.reject(s)];case 3:return[2]}}))}))},l.prototype.leave=function(e){var t,n;return i(this,void 0,void 0,(function(){var s;return r(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,4,,5]),!this.signal)throw f;if(!this.channelInfo)throw p;if(!this.client)throw v;return this.isGroupCall?[3,2]:[4,this.sendMessage("complete")];case 1:i.sent(),i.label=2;case 2:return[4,Promise.all([this.signalLeave(),this.rTCLeave()])];case 3:return i.sent(),this.log("leave success"),null===(t=null==e?void 0:e.success)||void 0===t||t.call(e),[3,5];case 4:return s=i.sent(),this.log("leave fail:",s),null===(n=null==e?void 0:e.failed)||void 0===n||n.call(e,s),[2,Promise.reject(s)];case 5:return[2]}}))}))},l.prototype.hangup=function(e){var t,n;return i(this,void 0,void 0,(function(){var s;return r(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,5,,6]),!this.signal)throw f;if(!this.channelInfo)throw p;return[4,Promise.all([this.signalCancel(),this.rTCLeave()])];case 1:return i.sent(),this.isGroupCall?[3,3]:[4,this.sendMessage("complete")];case 2:i.sent(),i.label=3;case 3:return[4,this.destroy()];case 4:return i.sent(),this.log("hangup success"),null===(t=null==e?void 0:e.success)||void 0===t||t.call(e),[3,6];case 5:return s=i.sent(),this.log("hangup fail:",s),null===(n=null==e?void 0:e.failed)||void 0===n||n.call(e,s),[2,Promise.reject(s)];case 6:return[2]}}))}))},l.prototype.setTokenService=function(e){this.getTokenFunc=e},l.prototype.setCallTimeout=function(e){this.callTimeout=this.rejectTimeout=e},l.prototype.setupLocalView=function(e){e&&(this.localView=e,this.log("setupLocalView set view success",e))},l.prototype.setupRemoteView=function(e,t){this.remoteViews.every((function(t){return t.userId!==e}))?this.remoteViews.push({userId:e,view:t}):this.remoteViews=this.remoteViews.map((function(n){return n.userId===e?s(s({},n),{view:t}):s({},n)}))},l.prototype.enableLocalVideo=function(e){return this._enableLocalVideo(e)},l.prototype.muteLocalAudio=function(e){return this._muteLocalAudio(e)},l.prototype.selectSpeakers=function(e){var t;return i(this,void 0,void 0,(function(){var n,s,i,a,o,l;return r(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,5,,6]),!this.client)throw v;if(!(n=null===(t=this.client.adapterRef)||void 0===t?void 0:t.audioHelperMap))throw h;if(!e)throw T;for(i in s=[],n)s.push(i);a=0,r.label=1;case 1:return a<s.length?(o=s[a],n[o]&&n[o].audioDomHelper&&n[o].audioDomHelper.audioDom?[4,this._selectSpeakers(n[o].audioDomHelper.audioDom,e)]:[3,3]):[3,4];case 2:r.sent(),r.label=3;case 3:return a++,[3,1];case 4:return this.log("selectSpeakers success",e),[3,6];case 5:return l=r.sent(),this.log("selectSpeakers fail: ",l,e),[2,Promise.reject(l)];case 6:return[2]}}))}))},l.prototype.getDevices=function(){return i(this,void 0,void 0,(function(){var t,n,i,a,o,l,c=this;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,e.getDevices()];case 1:for(o in t=r.sent(),n={audioIn:"microphoneId",audioOut:"speakerId",video:"cameraId"},i={},a=function(e){t.hasOwnProperty(e)&&(i[e]=t[e].map((function(t){return c[n[e]]===t.deviceId?s(s({},t),{active:!0}):s({},t)})))},t)a(o);return this.log("getDevices success",i),[2,i];case 2:return l=r.sent(),this.log("getDevices fail: ",l),[2,Promise.reject(l)];case 3:return[2]}}))}))},l.prototype.switchDevice=function(e,t){return i(this,void 0,void 0,(function(){var n;return r(this,(function(s){switch(s.label){case 0:switch(s.trys.push([0,8,,9]),e){case"microphoneId":return[3,1];case"cameraId":return[3,3];case"speakerId":return[3,5]}return[3,7];case 1:return this.microphoneId===t?[2,Promise.resolve()]:[4,this._muteLocalAudio(this.audioEnabled,t)];case 2:return s.sent(),[3,7];case 3:return this.cameraId===t?[2,Promise.resolve()]:[4,this._enableLocalVideo(this.videoEnabled,t)];case 4:return s.sent(),[3,7];case 5:return this.speakerId===t?[2,Promise.resolve()]:[4,this.selectSpeakers(t)];case 6:return s.sent(),[3,7];case 7:return this.log("switchDevice success",e,t),[3,9];case 8:return n=s.sent(),this.log("switchDevice fail: ",n,e,t),[2,Promise.reject(n)];case 9:return[2]}}))}))},l.prototype.getRoomInfo=function(){return i(this,void 0,void 0,(function(){var e,t;return r(this,(function(n){switch(n.label){case 0:if(n.trys.push([0,2,,3]),!this.channelInfo)throw p;if(!this.signal)throw f;return[4,this.signal.signalingGetChannelInfo({channelName:this.channelInfo.channelName})];case 1:return e=n.sent(),this.log("getRoomInfo success"),[2,s(s({},e),{uid:this.uid})];case 2:return t=n.sent(),this.log("getRoomInfo fail: ",t),[2,Promise.reject(t)];case 3:return[2]}}))}))},l.prototype.getSdkInstance=function(){return{signal:this.signal,rtcClient:this.client,WebRTC2:e}},l.prototype.signalCreate=function(e){var t=e.type;return i(this,void 0,void 0,(function(){var e,n;return r(this,(function(s){switch(s.label){case 0:this.callType||(this.callType=t),s.label=1;case 1:return s.trys.push([1,3,,4]),e=this,[4,this.signal.signalingCreate({type:t})];case 2:return e.channelInfo=s.sent(),this.log("signalingCreate Success","channelInfo:",this.channelInfo,"callType:",this.callType),[2,this.channelInfo];case 3:return n=s.sent(),this.log("signalingCreate failed:",n,"callType:",this.callType),[2,Promise.reject(n)];case 4:return[2]}}))}))},l.prototype.signalInvite=function(e){return i(this,void 0,void 0,(function(){var t,n,s,i;return r(this,(function(r){switch(r.label){case 0:if(!this.channelInfo)return[2,Promise.reject(p)];r.label=1;case 1:r.trys.push([1,6,,8]),t=JSON.stringify({callType:0}),n={channelId:this.channelInfo.channelId,offlineEnabled:!0,account:e,requestId:this.requestId,pushInfo:{pushTitle:"邀请通知",pushContent:"你收到了邀请",pushPayload:{},needPush:!0,needBadge:!0},attachExt:t},this.log("signalingInvite in call",n),r.label=2;case 2:return r.trys.push([2,4,,5]),[4,this.signal.signalingInvite(n)];case 3:return r.sent(),[3,5];case 4:if(s=r.sent(),!/OFFLINE/i.test(null==s?void 0:s.message))throw s;return[3,5];case 5:return this.log("signalInvite success！"),[3,8];case 6:return i=r.sent(),this.log("signalInvite fail:",{channelId:this.channelInfo.channelId,requestId:this.requestId},i),this.callingUserIds=this.callingUserIds.filter((function(t){return t!==e})),[4,this.destroy()];case 7:return r.sent(),[2,Promise.reject(i)];case 8:return[2]}}))}))},l.prototype.signalGroupInvite=function(e){return i(this,void 0,void 0,(function(){var t,n,s,i=this;return r(this,(function(r){switch(r.label){case 0:return this.channelInfo?(t=JSON.stringify({callType:1,callUserList:this.callingUserIds,groupID:void 0===e.groupId?null:e.groupId}),[4,Promise.allSettled(e.userIds.map((function(e){var n={channelId:i.channelInfo.channelId,offlineEnabled:!0,account:e,requestId:i.requestId,pushInfo:{pushTitle:"邀请通知",pushContent:"你收到了邀请",pushPayload:{},needPush:!0,needBadge:!0},attachExt:t};return i.log("signalingInvite in groupCall",n),i.signal.signalingInvite(n).then((function(){return Promise.resolve()})).catch((function(e){return/OFFLINE/i.test(null==e?void 0:e.message)?Promise.resolve():Promise.reject(e)}))})))]):[2,Promise.reject(p)];case 1:return(n=r.sent()).every((function(e){return"rejected"===e.status}))?(this.log("signalGroupInvite fail",n),[4,this.destroy()]):[3,3];case 2:return r.sent(),[2,Promise.reject(y)];case 3:return(s=e.userIds.filter((function(e,t){return"rejected"===n[t].status}))).length&&(this.log("signalGroupInvite part fail:",s),this.emit("onError",I,s)),this.callingUserIds=this.callingUserIds.filter((function(e){return!s.includes(e)})),this.log("signalGroupInvite success"),[2,Promise.resolve()]}}))}))},l.prototype.signalCancel=function(){return i(this,void 0,void 0,(function(){var e,t,n=this;return r(this,(function(s){switch(s.label){case 0:return[4,Promise.allSettled(this.callingUserIds.map((function(e){return n.signal.signalingCancel({channelId:n.channelInfo.channelId,account:e,requestId:n.requestId,offlineEnabled:!0})})))];case 1:return e=s.sent(),this.callStatus=c.idle,(t=this.callingUserIds.filter((function(t,n){return"rejected"===e[n].status}))).length&&(this.log("signalCancel part fail:",t),this.emit("onError",b,t)),this.callingUserIds=[],this.log("signalCancel success"),[2,Promise.resolve()]}}))}))},l.prototype.signalLeave=function(){return i(this,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,3,4]),[4,this.signal.signalingLeave({channelId:this.channelInfo.channelId,offlineEnabled:!0})];case 1:return t.sent(),this.log("signalLeave success"),[3,4];case 2:return e=t.sent(),this.log("signalLeave fail but resolve:",e),this.emit("onError",w),[3,4];case 3:return this.resetChannel(),[2,Promise.resolve()];case 4:return[2]}}))}))},l.prototype.signalClose=function(){return i(this,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:if(t.trys.push([0,2,3,4]),!this.signal)throw f;if(!this.channelInfo)throw p;return[4,this.signal.signalingClose({channelId:this.channelInfo.channelId,offlineEnabled:!0})];case 1:return t.sent(),this.log("signalClose success"),[3,4];case 2:return e=t.sent(),this.log("signalClose fail but resolve:",this.channelInfo,e),[3,4];case 3:return[2,Promise.resolve()];case 4:return[2]}}))}))},l.prototype.joinSignalAndRTC=function(){return i(this,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:if(!this.channelInfo)return[2,Promise.reject(p)];if(!this.callType)return[2,Promise.reject(m)];t.label=1;case 1:return t.trys.push([1,4,,5]),[4,this.signal.signalingJoin({channelId:this.channelInfo.channelId,offlineEnabled:!0,uid:this.uid})];case 2:return t.sent(),[4,this.joinRTCChannel()];case 3:return t.sent(),this.log("joinSignalAndRTC success"),[3,5];case 4:return e=t.sent(),this.log("joinSignalAndRTC fail:",e),this.destroy(),[2,Promise.reject(e)];case 5:return[2]}}))}))},l.prototype.acceptSignal=function(){return i(this,void 0,void 0,(function(){var e,t,n=this;return r(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),[4,this.signal.signalingAccept({channelId:this.invitorChannelInfo.channelId,account:this.invitorChannelInfo.from,requestId:this.invitorChannelInfo.requestId,offlineEnabled:!0,autoJoin:!0,uid:this.uid})];case 1:return e=s.sent(),this.log("signalingAccept success"),this.channelInfo=e,this.callType=this.invitorChannelInfo.type,e.members.forEach((function(e){n.userMap[e.uid]||(n.userMap[e.uid]=e.accid)})),this.invitorChannelInfo=null,this.log("acceptSignal success",e),this.isGroupCall?[4,this.joinRTCChannel()]:[3,3];case 2:s.sent(),s.label=3;case 3:return[3,5];case 4:return t=s.sent(),this.log("acceptSignal fail:",t),this.destroy(),[2,Promise.reject(t)];case 5:return[2]}}))}))},l.prototype.rTCSubscribe=function(e){return i(this,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:e.setSubscribeConfig({audio:!0,video:!0}),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.client.subscribe(e)];case 2:return n.sent(),this.log("rTCSubscribe success"),[3,4];case 3:return t=n.sent(),this.log("rTCSubscribe fail:",t),[3,4];case 4:return[2]}}))}))},l.prototype.rTCLeave=function(){return i(this,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,3,4]),[4,this.client.leave()];case 1:return t.sent(),this.log("rTCLeave success"),[3,4];case 2:return e=t.sent(),this.log("rTCLeave fail but resolve:",e),this.emit("onError",C),[3,4];case 3:return[2,Promise.resolve()];case 4:return[2]}}))}))},l.prototype.joinRTCChannel=function(){return i(this,void 0,void 0,(function(){var e,t;return r(this,(function(n){switch(n.label){case 0:if(n.trys.push([0,6,,7]),!this.channelInfo)throw p;return e="",this.getTokenFunc?[4,this.getTokenFunc(this.uid)]:[3,2];case 1:e=n.sent(),n.label=2;case 2:return[4,this.client.join({channelName:this.channelInfo.channelId,uid:this.uid,token:e})];case 3:return n.sent(),[4,this.initLocalStream()];case 4:return n.sent(),[4,this.client.publish(this.localStream)];case 5:return n.sent(),this.log("joinRTCChannel success"),[3,7];case 6:return t=n.sent(),this.log("joinRTCChannel fail:",t),[2,Promise.reject(t)];case 7:return[2]}}))}))},l.prototype.initLocalStream=function(){var t,n,s;return i(this,void 0,void 0,(function(){var i,a,o,l,c;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),this.localStream=e.createStream({uid:this.uid,audio:!0,video:2===this.callType,screen:!1}),this.log("localStream create success"),this.localStream.setVideoProfile({resolution:e.VIDEO_QUALITY_720p,frameRate:e.CHAT_VIDEO_FRAME_RATE_15}),this.localStream.setAudioProfile("speech_low_quality"),[4,this.localStream.init()];case 1:return r.sent(),this.log("localStream init success"),[4,this.getDevices()];case 2:return i=r.sent(),a=i.audioIn,o=i.audioOut,l=i.video,this.microphoneId=(null===(t=a[0])||void 0===t?void 0:t.deviceId)||"",this.cameraId=(null===(n=l[0])||void 0===n?void 0:n.deviceId)||"",this.speakerId=(null===(s=o[0])||void 0===s?void 0:s.deviceId)||"",[4,this.startStreamPreview(this.localStream,"local",this.localView)];case 3:return r.sent(),this.log("startLocalStreamPreview success",this.localStream,this.localView),this.log("initLocalStream success"),[3,5];case 4:return c=r.sent(),this.log("initLocalStream fail:",c),[2,Promise.reject(c)];case 5:return[2]}}))}))},l.prototype.startStreamPreview=function(e,t,n){return i(this,void 0,void 0,(function(){var s,i;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,e.play(n)];case 1:return r.sent(),this.log("startStreamPreview success",{stream:e,type:t,view:n}),n&&(s={width:n.clientWidth,height:n.clientHeight,cut:!0},e["local"===t?"setLocalRenderMode":"setRemoteRenderMode"](s),this.log("setLocalRenderMode success",{params:s,type:t})),[3,3];case 2:return i=r.sent(),this.log("startStreamPreview fail: ",i),[2,Promise.reject(i)];case 3:return[2]}}))}))},l.prototype.rejectCall=function(e){return void 0===e&&(e=!1),i(this,void 0,void 0,(function(){var t,n;return r(this,(function(s){switch(s.label){case 0:if(s.trys.push([0,2,3,4]),!this.signal)throw f;if(!this.invitorChannelInfo)throw p;return t={channelId:this.invitorChannelInfo.channelId,account:this.invitorChannelInfo.from,requestId:this.invitorChannelInfo.requestId,offlineEnabled:!0},e&&(t.attachExt="601"),[4,this.signal.signalingReject(t)];case 1:return s.sent(),this.invitorChannelInfo=null,this.log("rejectCall success"),[3,4];case 2:return n=s.sent(),this.log("rejectCall fail:",this.invitorChannelInfo,n),[2,Promise.reject(n)];case 3:return this.callStatus=c.idle,[7];case 4:return[2]}}))}))},l.prototype.filterCallingUserByMembers=function(e){void 0===e&&(e=[]),this.log("filterCallingUserByMembers:",e),this.callingUserIds=this.callingUserIds.filter((function(t){return e.every((function(e){return e.account!==t}))}))},l.prototype.sendMessage=function(e){var t=this;return new Promise((function(n,i){if(!t.signal)return i(f);if(!t.callType)return i(m);if(!t.channelInfo)return i(p);if(!t.durations.length)return i(S);var r={type:t.callType,channelId:t.channelInfo.channelId,status:{complete:1,canceled:2,rejected:3,timeout:4,busy:5}[e],durations:t.durations.map((function(e){return s(s({},e),{duration:e.duration?Date.now()-e.duration:null})}))};t.signal.sendG2Msg({attach:r,scene:"p2p",to:"cs2",done:function(e){if(e)return t.log("sendMessage fail:",r,e),i(e);t.log("sendMessage success",r),n()}})}))},l.prototype._enableLocalVideo=function(e,t){return i(this,void 0,void 0,(function(){var n;return r(this,(function(s){switch(s.label){case 0:if(s.trys.push([0,4,,5]),!this.localStream)throw g;return[4,this.localStream[e?"open":"close"]({type:"video",deviceId:t})];case 1:return s.sent(),this.videoEnabled=e,t&&(this.cameraId=t),e?[4,this.startStreamPreview(this.localStream,"local",this.localView)]:[3,3];case 2:s.sent(),s.label=3;case 3:return this.log("_enableLocalVideo success:",e,t),[3,5];case 4:return n=s.sent(),this.log("_enableLocalVideo fail:",e,t,n),[2,Promise.reject(n)];case 5:return[2]}}))}))},l.prototype._muteLocalAudio=function(e,t){return i(this,void 0,void 0,(function(){var n;return r(this,(function(s){switch(s.label){case 0:if(s.trys.push([0,2,,3]),!this.localStream)throw g;return[4,this.localStream[e?"open":"close"]({type:"audio",deviceId:t})];case 1:return s.sent(),this.audioEnabled=e,t&&(this.microphoneId=t),this.log("_muteLocalAudio success:",e,t),[3,3];case 2:return n=s.sent(),this.log("_muteLocalAudio fail:",e,t,n),[2,Promise.reject(n)];case 3:return[2]}}))}))},l.prototype._selectSpeakers=function(e,t){return i(this,void 0,void 0,(function(){var n;return r(this,(function(s){switch(s.label){case 0:if(e&&void 0===e.sinkId)return[2];s.label=1;case 1:return s.trys.push([1,3,,4]),[4,e.setSinkId(t)];case 2:return s.sent(),this.speakerId=t,[3,4];case 3:return n=s.sent(),[2,Promise.reject(n)];case 4:return[2]}}))}))},l.prototype.resetChannel=function(){var e=this;this.localStream=null,this.remoteStreams=[],this.localView=void 0,this.remoteViews=[],this.audioEnabled=!1,this.videoEnabled=!1,this.microphoneId="",this.cameraId="",this.speakerId="",this.channelInfo=null,this.callingUserIds=[],this.requestId="",this.callType=null,this.invitorChannelInfo=null,this.isGroupCall=!1,this.callStatus=c.idle,this.durations=[],Object.keys(this.userMap).forEach((function(t){t!==e.uid&&delete e.userMap[t]})),this.log("resetChannel success")},l.prototype.destroy=function(){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,Promise.all([this.signalClose(),this.rTCLeave()])];case 1:return e.sent(),this.resetChannel(),this.log("destroy success"),[2]}}))}))},l.prototype.addEventListener=function(){var e=this;this.signal.on("signalingNotify",(function(t){switch(t.eventType){case"ROOM_JOIN":e.signalRoomJoinHandler(t);break;case"ROOM_CLOSE":e.roomCloseHandler(t);break;case"INVITE":e.inviteHandler(t);break;case"CANCEL_INVITE":e.cancelInviteHandler(t);break;case"REJECT":e.rejectHandler(t);break;case"ACCEPT":e.acceptHandler(t);break;case"CONTROL":e.controlHandler(t)}})),this.signal.on("signalingMutilClientSyncNotify",(function(t){return i(e,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:switch(t.eventType){case"REJECT":return[3,1];case"ACCEPT":return[3,3]}return[3,5];case 1:return[4,this.rejectHandler(t)];case 2:return e.sent(),[3,5];case 3:return[4,this.acceptHandler(t)];case 4:return e.sent(),[3,5];case 5:return[2]}}))}))})),this.signal.on("signalingUnreadMessageSyncNotify",(function(t){e.log("signalingUnreadMessageSyncNotify",t),t.forEach((function(t){return i(e,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:switch(t.eventType){case"INVITE":return[3,1]}return[3,3];case 1:return[4,this.inviteHandler(t)];case 2:return e.sent(),[3,3];case 3:return[2]}}))}))}))})),this.client.on("peer-online",(function(t){e.roomJoinHandler(t)})),this.client.on("peer-leave",(function(t){e.leaveHandler(t)})),this.client.on("stream-added",(function(t){return i(e,void 0,void 0,(function(){var e,n;return r(this,(function(s){switch(s.label){case 0:return this.log("stream-added:",t),e=t.stream,n=e.getId(),this.remoteStreams.some((function(e){return e.getId()===n}))?(this.log("stream-added：订阅的流已存在，更新流"),this.remoteStreams=this.remoteStreams.map((function(t){return t.getId()===n?e:t}))):(this.log("stream-added：新增需要订阅的流"),this.remoteStreams.push(e)),[4,this.rTCSubscribe(e)];case 1:return s.sent(),[2]}}))}))})),this.client.on("stream-removed",(function(t){e.log("stream-removed:","callType:",e.callType,t);var n=t.stream,s=n.getId();n.stop(),e.log("stream-removed：停止订阅流，更新流"),e.remoteStreams=e.remoteStreams.map((function(e){return e.getId()===s?n:e}));var i=e.userMap[s];e.emit("onAudioAvailable",{userId:i,uid:s,available:n.audio}),2===e.callType&&e.emit("onCameraAvailable",{userId:i,uid:s,available:n.video})})),this.client.on("stream-subscribed",(function(t){return i(e,void 0,void 0,(function(){var e,n,s,i,a;return r(this,(function(r){switch(r.label){case 0:this.log("stream-subscribed:","callType:",this.callType,t),e=t.stream,n=e.getId(),s=this.userMap[n],this.emit("onAudioAvailable",{userId:s,uid:n,available:e.audio}),2===this.callType&&this.emit("onCameraAvailable",{userId:s,uid:n,available:e.video}),i=(this.remoteViews.find((function(e){return e.userId===s}))||{view:void 0}).view,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.startStreamPreview(e,"remote",i)];case 2:return r.sent(),this.log("startRemoteStreamPreview success",e,i),[3,4];case 3:return a=r.sent(),this.log("startRemoteStreamPreview fail: ",e,i,a),[3,4];case 4:return[2]}}))}))})),this.client.on("network-quality",(function(t){e.log("network-quality: ",t);var n={};t.forEach((function(t){var s=e.userMap[t.uid];s&&(n[s]={uplinkNetworkQuality:t.uplinkNetworkQuality,downlinkNetworkQuality:t.downlinkNetworkQuality})})),e.emit("onUserNetworkQuality",n)}))},l.prototype.signalRoomJoinHandler=function(e){var t;this.log("signalRoomJoinHandler:",e);try{t=JSON.parse(e.attach)}catch(e){t={}}var n=(t.member||{})[2];this.filterCallingUserByMembers([{uid:n,account:e.from}]),this.userMap[n]=e.from},l.prototype.roomCloseHandler=function(e){return i(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return this.log("roomCloseHandler:",e),[4,this.destroy()];case 1:return t.sent(),this.emit("onCallEnd"),[2]}}))}))},l.prototype.roomJoinHandler=function(e){var t=this.userMap[e.uid];this.log("roomJoinHandler:",t,e),this.emit("onUserEnter",t)},l.prototype.acceptHandler=function(e){return i(this,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:if(this.callStatus=c.inCall,this.emit("onUserAccept",e.from),this.isGroupCall)return this.log("acceptHandler from group:",e),[2,Promise.resolve()];n.label=1;case 1:if(n.trys.push([1,4,,5]),!this.channelInfo)throw p;if(!this.callType)throw m;if(!this.signal)throw f;return[4,this.joinRTCChannel()];case 2:return n.sent(),this.durations.push({accid:e.from,duration:Date.now()}),[4,this.signal.signalingControl({channelId:this.channelInfo.channelId,account:e.from,attachExt:JSON.stringify({cid:1})})];case 3:return n.sent(),this.log("acceptHandler from signal success:",e),[3,5];case 4:return t=n.sent(),this.log("acceptHandler from signal fail:",e,t),this.emit("onError",t),[3,5];case 5:return[2]}}))}))},l.prototype.inviteHandler=function(e){return i(this,void 0,void 0,(function(){var t,n,s,a=this;return r(this,(function(o){switch(o.label){case 0:if(e.channelInValid)return[2];this.log("inviteHandler:","callStatus:",this.callStatus,e);try{t=JSON.parse(e.attachExt)}catch(e){t={}}if(n=Number(e.type),this.invitorChannelInfo={channelId:e.channelId,channelName:e.channelName,creatorId:e.creator,requestId:e.requestId,from:e.from,type:n},this.callStatus===c.idle)return[3,5];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.rejectCall(!0)];case 2:return o.sent(),[3,4];case 3:return s=o.sent(),this.log("reject error in inviteHandler: ",s),[3,4];case 4:return[2];case 5:return this.callStatus=c.called,this.isGroupCall=t.callType+""=="1",this.emit("onInvited",{invitor:e.from,userIds:t.callUserList,isFromGroup:this.isGroupCall,groupId:t.groupID,type:n}),void 0!==this.rejectTimeout&&setTimeout((function(){return i(a,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:if(this.callStatus!==c.called)return[3,5];t.label=1;case 1:return t.trys.push([1,3,4,5]),[4,this.rejectCall(!1)];case 2:return t.sent(),this.log("reject timeout success",this.rejectTimeout),[3,5];case 3:return e=t.sent(),this.log("reject timeout fail: ",e,this.rejectTimeout),[3,5];case 4:return this.emit("onCallingTimeOut"),[7];case 5:return[2]}}))}))}),this.rejectTimeout),[2]}}))}))},l.prototype.cancelInviteHandler=function(e){this.log("cancelInviteHandler:",e),this.callStatus=c.idle,this.emit("onUserCancel",e.from)},l.prototype.rejectHandler=function(e){return i(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return this.log("rejectHandler:",e),this.filterCallingUserByMembers([{uid:"",account:e.from}]),"601"!==e.attachExt?[3,3]:(this.emit("onUserBusy",e.from),this.isGroupCall?[3,2]:[4,this.sendMessage("busy")]);case 1:t.sent(),t.label=2;case 2:return[3,5];case 3:return this.emit("onUserReject",e.from),this.isGroupCall?[3,5]:[4,this.sendMessage("rejected")];case 4:t.sent(),t.label=5;case 5:return this.isGroupCall?[3,7]:[4,this.destroy()];case 6:t.sent(),t.label=7;case 7:return[2]}}))}))},l.prototype.controlHandler=function(e){return i(this,void 0,void 0,(function(){var t,n;return r(this,(function(s){switch(s.label){case 0:this.log("controlHandler: ","channelInfo: ",this.channelInfo,"callType: ",this.callType,e),s.label=1;case 1:if(s.trys.push([1,3,,4]),!this.channelInfo)throw p;if(!this.callType)throw m;t=void 0;try{t=JSON.parse(e.attachExt)}catch(e){t={}}return 1!==t.cid?[2]:[4,this.joinRTCChannel()];case 2:return s.sent(),this.isGroupCall||(this.durations=[{accid:this.userMap[this.uid],duration:Date.now()},{accid:e.from,duration:Date.now()}]),this.log("controlHandler success: ",this.durations),[3,4];case 3:return n=s.sent(),this.log("controlHandler fail: ",n),[3,4];case 4:return[2]}}))}))},l.prototype.leaveHandler=function(e){return i(this,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return this.log("leaveHandler:",e),this.remoteStreams=this.remoteStreams.filter((function(t){return t.getId()!==e.uid})),t=this.userMap[e.uid],delete this.userMap[e.uid],this.isGroupCall?[3,2]:[4,this.destroy()];case 1:n.sent(),n.label=2;case 2:return this.emit("onUserLeave",t),[2]}}))}))},l.version="0.0.2",l}(u);export{P as RTCCalling};
